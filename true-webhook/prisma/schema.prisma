generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========

enum UserRole {
  MASTER
  NETWORK_ADMIN
  NETWORK_USER
}

// ========== MASTER DATA ==========

model SystemSetting {
  key   String @id
  value String
  
  updatedAt DateTime @updatedAt
}


model Network {
  id          String    @id @default(cuid())
  prefix      String    @unique
  name        String
  logoUrl     String?   // Custom logo URL
  isActive    Boolean   @default(true)
  
  // Real-time settings
  realtimeEnabled         Boolean   @default(true)
  checkIntervalMs         Int       @default(2000)  // Milliseconds between checks
  
  // Telegram notification settings
  telegramBotToken        String?
  telegramChatId          String?
  telegramEnabled         Boolean   @default(false)
  notifyMoneyIn           Boolean   @default(true)
  notifyMoneyOut          Boolean   @default(true)
  notifyMinAmount         Int       @default(0)     // Minimum amount (satang) to trigger notification
  
  users       User[]
  accounts    Account[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  displayName  String?
  role         UserRole  @default(NETWORK_USER)
  
  networkId    String?
  network      Network?  @relation(fields: [networkId], references: [id], onDelete: SetNull)
  
  lastLoginAt  DateTime?
  refreshToken String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@index([networkId])
  @@index([email])
}

// ========== NETWORK DATA ==========

model Account {
  id                         String           @id @default(cuid())
  name                       String
  phoneNumber                String?
  isActive                   Boolean          @default(true)
  
  walletEndpointUrl          String
  walletBearerToken          String
  
  autoRefreshEnabled         Boolean          @default(true)
  autoRefreshIntervalSeconds Int              @default(60)
  
  networkId                  String
  network                    Network          @relation(fields: [networkId], references: [id], onDelete: Cascade)
  
  telegramConfig             TelegramConfig?
  balanceSnapshots           BalanceSnapshot[]
  notificationLogs           NotificationLog[]
  transactions               Transaction[]
  
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  
  @@index([networkId])
}

model TelegramConfig {
  id             String   @id @default(cuid())
  accountId      String   @unique
  botToken       String
  chatId         String
  enabled        Boolean  @default(true)
  notifyMoneyIn  Boolean  @default(true)
  notifyMoneyOut Boolean  @default(true)
  
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BalanceSnapshot {
  id              String    @id @default(cuid())
  accountId       String
  balanceSatang   Int
  mobileNo        String?
  source          String?
  walletUpdatedAt DateTime?
  checkedAt       DateTime  @default(now())
  
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, checkedAt])
}

enum NotificationType {
  balance_change
  telegram_sent
  telegram_failed
  system
}

model NotificationLog {
  id        String           @id @default(cuid())
  type      NotificationType
  message   String
  payload   Json?
  accountId String?
  
  account   Account?         @relation(fields: [accountId], references: [id], onDelete: SetNull)
  
  createdAt DateTime         @default(now())
  
  @@index([accountId, createdAt])
}

model Transaction {
  id              String   @id @default(cuid())
  transactionId   String   @unique // TrueMoney Transaction ID
  accountId       String
  
  amount          Float    // Net amount
  fee             Float    @default(0)
  
  type            String   // 'incoming' or 'outgoing'
  status          String   // 'SUCCESS', 'PENDING', 'FAILED'
  
  senderName      String?
  senderMobile    String?
  recipientName   String?
  recipientMobile String?
  
  ref1            String?
  ref2            String?
  ref3            String?
  
  rawPayload      Json?    // Full webhook payload
  
  timestamp       DateTime // Transaction time from TrueMoney
  createdAt       DateTime @default(now())
  
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, timestamp])
  @@index([transactionId])
}
