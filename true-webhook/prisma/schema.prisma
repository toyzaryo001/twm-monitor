generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========

enum UserRole {
  MASTER
  NETWORK_ADMIN
  NETWORK_USER
}

// ========== MASTER DATA ==========

model SystemSetting {
  key   String @id
  value String
  
  updatedAt DateTime @updatedAt
}


model Network {
  id          String    @id @default(cuid())
  prefix      String    @unique
  name        String
  logoUrl     String?   // Custom logo URL
  isActive    Boolean   @default(true)
  
  // Real-time settings
  realtimeEnabled         Boolean   @default(true)
  checkIntervalMs         Int       @default(2000)  // Milliseconds between checks
  featureWebhookEnabled   Boolean   @default(true)
  featureAutoWithdraw     Boolean   @default(false)
  
  // Expiration
  expiredAt               DateTime?
  
  // Telegram notification settings
  telegramBotToken        String?
  telegramChatId          String?
  telegramEnabled         Boolean   @default(false)
  notifyMoneyIn           Boolean   @default(true)
  notifyMoneyOut          Boolean   @default(true)
  notifyMinAmount         Int       @default(0)     // Minimum amount (satang) to trigger notification
  
  // Bank account for payments
  bankName                String?   // e.g. "กสิกรไทย"
  bankAccountNumber       String?   // e.g. "xxx-x-xxxxx-x"
  bankAccountName         String?   // e.g. "บจก. ทรู เว็บฮุก"
  
  users       User[]
  accounts    Account[]
  announcementNetworks AnnouncementNetwork[]
  paymentRequests      PaymentRequest[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  displayName  String?
  role         UserRole  @default(NETWORK_USER)
  
  networkId    String?
  network      Network?  @relation(fields: [networkId], references: [id], onDelete: SetNull)
  
  lastLoginAt  DateTime?
  refreshToken String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@index([networkId])
  @@index([email])
}

// ========== NETWORK DATA ==========

model Account {
  id                         String           @id @default(cuid())
  name                       String
  phoneNumber                String?
  isActive                   Boolean          @default(true)
  
  walletEndpointUrl          String
  walletBearerToken          String
  webhookSecret              String?          // For verifying incoming webhook requests
  
  autoRefreshEnabled         Boolean          @default(true)
  autoRefreshIntervalSeconds Int              @default(60)
  
  networkId                  String
  network                    Network          @relation(fields: [networkId], references: [id], onDelete: Cascade)
  
  telegramConfig             TelegramConfig?
  autoWithdrawConfig         AutoWithdrawConfig?
  balanceSnapshots           BalanceSnapshot[]
  notificationLogs           NotificationLog[]
  transactions               FinancialTransaction[]
  
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  
  @@index([networkId])
}

model TelegramConfig {
  id             String   @id @default(cuid())
  accountId      String   @unique
  botToken       String
  chatId         String
  enabled        Boolean  @default(true)
  notifyMoneyIn  Boolean  @default(true)
  notifyMoneyOut Boolean  @default(true)
  
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BalanceSnapshot {
  id              String    @id @default(cuid())
  accountId       String
  balanceSatang   Int
  mobileNo        String?
  source          String?
  walletUpdatedAt DateTime?
  checkedAt       DateTime  @default(now())
  
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, checkedAt])
}

enum NotificationType {
  balance_change
  telegram_sent
  telegram_failed
  system
  webhook_debug
}

model NotificationLog {
  id        String           @id @default(cuid())
  type      NotificationType
  message   String
  payload   Json?
  accountId String?
  
  account   Account?         @relation(fields: [accountId], references: [id], onDelete: SetNull)
  
  createdAt DateTime         @default(now())
  
  @@index([accountId, createdAt])
}

model FinancialTransaction {
  id              String   @id @default(cuid())
  transactionId   String   @unique // TrueMoney Transaction ID
  accountId       String
  
  amount          Float    // Net amount
  fee             Float    @default(0)
  
  type            String   // 'incoming' or 'outgoing'
  status          String   // 'SUCCESS', 'PENDING', 'FAILED'
  
  senderName      String?
  senderMobile    String?
  recipientName   String?
  recipientMobile String?
  
  ref1            String?
  ref2            String?
  ref3            String?
  
  rawPayload      Json?    // Full webhook payload
  
  timestamp       DateTime // Transaction time from TrueMoney
  createdAt       DateTime @default(now())
  
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
}

// ========== AUTO WITHDRAW ==========

enum WithdrawType {
  ALL_EXCEPT
  FIXED_AMOUNT
}

model AutoWithdrawConfig {
  id                String       @id @default(cuid())
  accountId         String       @unique
  enabled           Boolean      @default(false)
  triggerMinBalance Float        @default(1000)
  targetNumber      String
  withdrawType      WithdrawType @default(ALL_EXCEPT)
  amountValue       Float        @default(0) // If ALL_EXCEPT, keep this amount. If FIXED_AMOUNT, withdraw this amount.
  
  account           Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  updatedAt         DateTime     @updatedAt
}

model AutoWithdrawLog {
  id             String   @id @default(cuid())
  accountId      String
  amount         Float
  targetNumber   String
  status         String   // SUCCESS, FAILED
  message        String?  // Error message or Ref ID
  
  createdAt      DateTime @default(now())
  

  @@index([accountId, createdAt])
}

// ========== ANNOUNCEMENTS ==========

enum AnnouncementType {
  POPUP
  MARQUEE
}

model Announcement {
  id          String           @id @default(cuid())
  title       String
  content     String           @db.Text
  type        AnnouncementType @default(POPUP)
  isActive    Boolean          @default(true)
  
  // Scoping: If empty, applies to ALL networks (Global)
  networks    AnnouncementNetwork[]
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model AnnouncementNetwork {
  id             String       @id @default(cuid())
  announcementId String
  networkId      String
  
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  network        Network      @relation(fields: [networkId], references: [id], onDelete: Cascade)
  
  @@unique([announcementId, networkId])
  @@index([networkId])
}

// ========== PRICING & SLIPS ==========

model Package {
  id            String    @id @default(cuid())
  name          String
  price         Float
  durationDays  Int
  description   String?
  isActive      Boolean   @default(true)
  
  paymentRequests PaymentRequest[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model PaymentRequest {
  id          String    @id @default(cuid())
  
  networkId   String
  network     Network   @relation(fields: [networkId], references: [id], onDelete: Cascade)
  
  packageId   String
  package     Package   @relation(fields: [packageId], references: [id])
  
  amount      Float
  slipUrl     String    // Path or URL to slip image
  status      String    // PENDING, APPROVED, REJECTED
  
  reviewedBy  String?   // Admin ID who reviewed
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([networkId])
  @@index([status])
}

